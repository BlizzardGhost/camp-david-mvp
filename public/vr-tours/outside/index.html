<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Camp David Outside – 360° Tour</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/pannellum@2.5.6/build/pannellum.css">
  <script src="https://unpkg.com/pannellum@2.5.6/build/pannellum.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#000}
    #pano{width:100%;height:100%}
    .pnlm-hotspot-tooltip{background:rgba(0,0,0,.7);color:#fff;padding:.25rem .5rem;border-radius:.5rem}
  </style>
</head>
<body>
  <div id="pano" aria-label="Camp David Outside – 360° Tour"></div>
  <script>
    const jsonUrl = './wpvr_1317.json';

    // Map WPVR scene IDs -> your local JPG filenames
    const LOCAL_IMG = {
      MapleCrest: 'MapleCrest.jpg',
      OutsideMC: 'OutsideMC.jpg',
      Between: 'Between.jpg',
      NearLF: 'NearLF.jpg',
      LF: 'LF.jpg',
      Lakeview: 'Lakeview.jpg',
      OutsideTable: 'OutsideTable.jpg',
      LakeChairView: 'LakeChairView.jpg',
      Dock: 'Dock.jpg',
      Boat: 'Boat.jpg',
      HillTopOutside: 'HillTopOutside.jpg'
    };

    const stripHTML = s => (s||'').replace(/<[^>]*>/g,'').trim();

    (async () => {
      try {
        const data = await fetch(jsonUrl).then(r => r.json());
        const list = (data?.data?.panodata?.['scene-list']) || {};
        const defaultScene = data?.data?.defaultscene;
        const scenes = {};
        let firstSceneId = null;

        Object.keys(list).forEach(k => {
          const s = list[k];
          const id = s['scene-id'];
          if (!id) return;
          if (!firstSceneId) firstSceneId = id;

          // Use local file if we have it; fall back to WP URL if not
          const localFile = LOCAL_IMG[id];
          const img = localFile ? ('./' + localFile) : s['scene-attachment-url'];

          const hsRaw = Array.isArray(s['hotspot-list']) ? s['hotspot-list'] : [];
          const hotSpots = hsRaw.map(h => {
            const pitch = parseFloat(String(h['hotspot-pitch']||'0'));
            const yaw   = parseFloat(String(h['hotspot-yaw']||'0'));
            const isScene = (h['hotspot-type'] === 'scene');
            const text = stripHTML(h['hotspot-hover'] || h['hotspot-title'] || '');
            const sceneId = h['hotspot-scene'] || undefined;
            const URL = h['hotspot-url'] || undefined;
            const base = { pitch, yaw };
            return isScene
              ? { ...base, type:'scene', sceneId, text: text || sceneId || '' }
              : { ...base, type:'info', text, URL };
          });

          scenes[id] = { type:'equirectangular', panorama: img, autoLoad:true, hfov:100, hotSpots };
        });

        const start = (defaultScene && scenes[defaultScene]) ? defaultScene : firstSceneId;

        pannellum.viewer('pano', {
          default: { firstScene: start, autoLoad: true, sceneFadeDuration: parseInt(data?.data?.scenefadeduration||'500',10)||500 },
          scenes
        });
      } catch (e) {
        console.error(e);
        document.getElementById('pano').innerHTML =
          '<div style="color:#fff;display:flex;align-items:center;justify-content:center;height:100%">Unable to load tour.</div>';
      }
    })();
  </script>
</body>
</html>
